<!doctype html>
<html lang="ja">
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />

        <title>画像圧縮 - t_o_d ツール</title>
        <meta name="title" content="画像圧縮 - t_o_d ツール" />
        <meta name="description" content="画像圧縮ツールです。" />
        <meta
            name="keywords"
            content="t_o_d, tool, tech, 画像圧縮, プログラミング"
        />
        <meta name="author" content="t_o_d" />
        <meta name="robots" content="index, follow" />
        <meta name="language" content="Japanese" />

        <!-- Open Graph -->
        <meta property="og:type" content="article" />
        <meta property="og:url" content="https://github.com/Kamekure-Maisuke" />
        <meta
            property="og:title"
            content="ユーザーエージェント確認 - t_o_d ツール"
        />
        <meta property="og:description" content="これは画像圧縮ツールです。" />
        <meta property="og:locale" content="ja_JP" />
        <meta property="og:site_name" content="t_o_d Portfolio" />

        <!-- Theme Color -->
        <meta name="theme-color" content="#1f2937" />

        <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin />
        <link rel="dns-prefetch" href="https://cdn.jsdelivr.net" />
        <link
            rel="stylesheet"
            href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.min.css"
            fetchpriority="high"
        />

        <!-- Structured Data (JSON-LD) for Article -->
        <script type="application/ld+json">
            {
                "@context": "https://schema.org",
                "@type": "Tool",
                "name": "t_o_d Tool",
                "description": "t_o_dの画像圧縮ツールです。",
                "author": {
                    "@type": "Person",
                    "name": "t_o_d"
                }
            }
        </script>
    </head>

    <body>
        <header class="container" role="banner">
            <nav>
                <ul>
                    <li><a href="/">ホーム</a></li>
                    <li><a href="/blogs/">ブログ</a></li>
                    <li><a href="/tools/">ツール</a></li>
                </ul>
            </nav>
        </header>

        <main class="container" role="main" aria-label="Compress Image Tool">
            <header>
                <hgroup>
                    <h1>画像圧縮ツール</h1>
                    <p>
                        ブラウザ上で画像を圧縮できるツールです。JPGとPNG形式に対応しており、画像をサーバーに送信せずクライアント側で安全に処理します。圧縮品質を調整して、ファイルサイズを削減できます。
                    </p>
                </hgroup>
            </header>

            <section aria-labelledby="compress-image-tool-heading">
                <h2 id="compress-image-tool-heading" hidden>画像圧縮ツール</h2>

                <article>
                    <h3>画像を選択</h3>
                    <input
                        type="file"
                        id="imageInput"
                        accept="image/jpeg,image/png,image/jpg"
                        aria-label="圧縮する画像を選択"
                    />
                    <small>対応形式: JPG, PNG</small>
                </article>

                <article id="controlsSection" style="display: none">
                    <h3>圧縮設定</h3>
                    <label for="quality">
                        圧縮品質: <span id="qualityValue">80</span>%
                        <input
                            type="range"
                            id="quality"
                            min="1"
                            max="100"
                            value="80"
                            aria-label="圧縮品質"
                        />
                    </label>
                    <small
                        >品質を下げるとファイルサイズが小さくなりますが、画質が低下します</small
                    >
                </article>

                <article id="previewSection" style="display: none">
                    <h3>プレビュー</h3>
                    <div style="display: grid; gap: 1rem">
                        <div>
                            <h4>元の画像</h4>
                            <canvas
                                id="originalCanvas"
                                style="
                                    max-width: 100%;
                                    height: auto;
                                    border: 1px solid
                                        var(--pico-muted-border-color);
                                "
                            ></canvas>
                            <p>
                                <small
                                    >サイズ:
                                    <span id="originalSize">-</span></small
                                >
                            </p>
                        </div>
                        <div>
                            <h4>圧縮後の画像</h4>
                            <canvas
                                id="compressedCanvas"
                                style="
                                    max-width: 100%;
                                    height: auto;
                                    border: 1px solid
                                        var(--pico-muted-border-color);
                                "
                            ></canvas>
                            <p>
                                <small
                                    >サイズ:
                                    <span id="compressedSize">-</span></small
                                >
                            </p>
                        </div>
                    </div>
                </article>

                <article id="actionsSection" style="display: none">
                    <button id="compressBtn" aria-label="画像を圧縮">
                        圧縮する
                    </button>
                    <button
                        id="downloadBtn"
                        class="secondary"
                        style="display: none"
                        aria-label="圧縮した画像をダウンロード"
                    >
                        ダウンロード
                    </button>
                </article>
            </section>

            <footer role="contentinfo">
                <small>&copy; 2025 t_o_d. All rights reserved.</small>
            </footer>
        </main>

        <script>
            (() => {
                let originalFile = null;
                let originalImage = null;
                let compressedBlob = null;

                const imageInput = document.getElementById("imageInput");
                const qualityInput = document.getElementById("quality");
                const qualityValue = document.getElementById("qualityValue");
                const compressBtn = document.getElementById("compressBtn");
                const downloadBtn = document.getElementById("downloadBtn");
                const originalCanvas =
                    document.getElementById("originalCanvas");
                const compressedCanvas =
                    document.getElementById("compressedCanvas");
                const originalSize = document.getElementById("originalSize");
                const compressedSize =
                    document.getElementById("compressedSize");
                const controlsSection =
                    document.getElementById("controlsSection");
                const previewSection =
                    document.getElementById("previewSection");
                const actionsSection =
                    document.getElementById("actionsSection");

                function formatFileSize(bytes) {
                    if (bytes === 0) return "0 Bytes";
                    const k = 1024;
                    const sizes = ["Bytes", "KB", "MB"];
                    const i = Math.floor(Math.log(bytes) / Math.log(k));
                    return (
                        Math.round((bytes / Math.pow(k, i)) * 100) / 100 +
                        " " +
                        sizes[i]
                    );
                }

                function loadImage(file) {
                    return new Promise((resolve, reject) => {
                        const img = new Image();
                        const reader = new FileReader();

                        reader.onload = (e) => {
                            img.onload = () => resolve(img);
                            img.onerror = reject;
                            img.src = e.target.result;
                        };
                        reader.onerror = reject;
                        reader.readAsDataURL(file);
                    });
                }

                function drawImageToCanvas(canvas, image) {
                    const ctx = canvas.getContext("2d");
                    canvas.width = image.width;
                    canvas.height = image.height;
                    ctx.drawImage(image, 0, 0);
                }

                imageInput.addEventListener("change", async (e) => {
                    const file = e.target.files[0];
                    if (!file) return;

                    if (!file.type.match(/image\/(jpeg|png)/)) {
                        alert("JPGまたはPNG形式の画像を選択してください。");
                        imageInput.value = "";
                        return;
                    }

                    try {
                        originalFile = file;
                        originalImage = await loadImage(file);

                        drawImageToCanvas(originalCanvas, originalImage);
                        originalSize.textContent = formatFileSize(file.size);

                        controlsSection.style.display = "block";
                        previewSection.style.display = "block";
                        actionsSection.style.display = "block";
                        downloadBtn.style.display = "none";
                        compressedSize.textContent = "-";

                        const ctx = compressedCanvas.getContext("2d");
                        ctx.clearRect(
                            0,
                            0,
                            compressedCanvas.width,
                            compressedCanvas.height,
                        );
                    } catch (error) {
                        alert("画像の読み込みに失敗しました。");
                        console.error(error);
                    }
                });

                qualityInput.addEventListener("input", (e) => {
                    qualityValue.textContent = e.target.value;
                });

                compressBtn.addEventListener("click", async () => {
                    if (!originalImage || !originalFile) {
                        alert("画像を選択してください。");
                        return;
                    }

                    try {
                        compressBtn.ariaBusy = "true";
                        compressBtn.disabled = true;

                        const quality = parseInt(qualityInput.value) / 100;
                        const outputFormat =
                            originalFile.type === "image/png"
                                ? "image/png"
                                : "image/jpeg";

                        drawImageToCanvas(compressedCanvas, originalImage);

                        compressedBlob = await new Promise((resolve) => {
                            compressedCanvas.toBlob(
                                (blob) => resolve(blob),
                                outputFormat,
                                quality,
                            );
                        });

                        compressedSize.textContent = formatFileSize(
                            compressedBlob.size,
                        );

                        const reduction =
                            ((originalFile.size - compressedBlob.size) /
                                originalFile.size) *
                            100;
                        if (reduction > 0) {
                            compressedSize.textContent += ` (${Math.round(reduction)}% 削減)`;
                        } else {
                            compressedSize.textContent +=
                                " (サイズが増加しました)";
                        }

                        downloadBtn.style.display = "block";
                    } catch (error) {
                        alert("圧縮処理中にエラーが発生しました。");
                        console.error(error);
                    } finally {
                        compressBtn.ariaBusy = "false";
                        compressBtn.disabled = false;
                    }
                });

                downloadBtn.addEventListener("click", () => {
                    if (!compressedBlob || !originalFile) return;

                    const url = URL.createObjectURL(compressedBlob);
                    const a = document.createElement("a");
                    const extension =
                        originalFile.type === "image/png" ? "png" : "jpg";
                    const baseName = originalFile.name.replace(/\.[^/.]+$/, "");

                    a.href = url;
                    a.download = `${baseName}_compressed.${extension}`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                });
            })();
        </script>
    </body>
</html>
